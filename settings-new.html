<div class="battle-settings-container">
    <div class="settings-header">
        <h2 class="main-title">ğŸ® AIç­–ç•¥å¯¹æˆ˜é…ç½®</h2>
        <p class="subtitle">é…ç½®æ‚¨çš„AIå¯¹æˆ˜ç¯å¢ƒ</p>
    </div>

    <!-- æ¸¸æˆæ¨¡å¼é€‰æ‹© -->
    <div class="settings-section mode-section">
        <h3 class="section-title">
            <span class="title-icon">ğŸ¯</span>
            <span>æ¸¸æˆæ¨¡å¼</span>
        </h3>
        <select id="game_mode" class="input-field">
            <option value="universal">é€šç”¨æ¨¡å¼ï¼ˆä¾èµ–ä¸–ç•Œä¹¦/é…’é¦†AIï¼‰</option>
            <option value="werewolf">ç‹¼äººæ€æ¨¡å¼ï¼ˆå†…ç½®è§„åˆ™ï¼Œæ— éœ€ä¸–ç•Œä¹¦ï¼‰</option>
        </select>
        <div class="info-box">
            <div class="info-item">
                <span class="info-icon">ğŸ’¡</span>
                <div>
                    <strong>é€šç”¨æ¨¡å¼</strong>
                    <p>ç”±é…’é¦†AIï¼ˆä¸–ç•Œä¹¦ï¼‰å®šä¹‰è§„åˆ™ï¼ŒGMæ ¹æ®è§„åˆ™ä¸»æŒ</p>
                </div>
            </div>
            <div class="info-item">
                <span class="info-icon">ğŸº</span>
                <div>
                    <strong>ç‹¼äººæ€æ¨¡å¼</strong>
                    <p>æ‰©å±•å†…ç½®å®Œæ•´ç‹¼äººæ€è§„åˆ™ï¼Œè‡ªåŠ¨ç®¡ç†æ¸¸æˆæµç¨‹</p>
                </div>
            </div>
        </div>
    </div>

    <!-- GMç³»ç»Ÿæç¤ºè¯ -->
    <div class="settings-section" id="gm_system_prompt_section">
        <h3 class="section-title">
            <span class="title-icon">ğŸ­</span>
            <span>GM ç³»ç»Ÿæç¤ºè¯</span>
        </h3>
        <p class="section-description">
            è¿™æ®µæç¤ºè¯ä¼šåœ¨æ¯æ¬¡è°ƒç”¨ GM æ—¶è‡ªåŠ¨é™„åŠ ï¼Œç”¨äºæ˜ç¡® GM çš„èº«ä»½å’Œä»»åŠ¡ã€‚
        </p>
        <textarea id="gm_system_prompt" class="input-field textarea-field" rows="6" placeholder="è¾“å…¥GMç³»ç»Ÿæç¤ºè¯...">ä½ æ˜¯ä¸€ä¸ªæ¸¸æˆä¸»æŒäººï¼ˆGMï¼‰ï¼Œè´Ÿè´£åè°ƒå¤šä¸ªAIç©å®¶è¿›è¡Œæ¸¸æˆã€‚

ä½ çš„èŒè´£ï¼š
1. ä¸¥æ ¼æ ¹æ®èŠå¤©è®°å½•ä¸­çš„æ¸¸æˆè§„åˆ™ä¸»æŒæ¸¸æˆ
2. ä½¿ç”¨ã€è½®åˆ°ï¼šç©å®¶åã€‘æ¥æŒ‡å®šæŸä¸ªç©å®¶å…¬å¼€è¡ŒåŠ¨
3. ä½¿ç”¨ã€ç§˜å¯†æŒ‡ç¤ºï¼šç©å®¶å|å†…å®¹ã€‘æ¥ç»™æŸä¸ªç©å®¶å‘é€ç§˜å¯†ä¿¡æ¯
4. ç»å¯¹ä¸è¦åç¦»å½“å‰æ¸¸æˆä¸»é¢˜ï¼Œä¸è¦å›ç­”æ— å…³é—®é¢˜</textarea>
    </div>

    <!-- GM & è§£è¯´å‘˜ API é…ç½® -->
    <div class="settings-section api-section">
        <h3 class="section-title">
            <span class="title-icon">ğŸ¤–</span>
            <span>GM & è§£è¯´å‘˜ API é…ç½®</span>
        </h3>
        
        <!-- è§£è¯´å‘˜å¼€å…³ -->
        <div class="commentator-toggle">
            <label class="toggle-label">
                <input type="checkbox" id="commentatorEnabled" class="toggle-checkbox" />
                <span class="toggle-switch"></span>
                <span class="toggle-text">å¯ç”¨AIè§£è¯´å‘˜ï¼ˆä»…ç‹¼äººæ€æ¨¡å¼ï¼‰</span>
            </label>
            <p class="toggle-description">ä½¿ç”¨ä¸‹æ–¹APIé…ç½®ç”Ÿæˆæ¸¸æˆè§£è¯´ï¼Œå¢åŠ è§‚èµæ€§</p>
        </div>

        <div class="commentator-style-box">
            <label class="field-label">è§£è¯´é£æ ¼ï¼ˆå¯é€‰ï¼‰</label>
            <textarea 
                id="commentatorStyle" 
                class="input-field textarea-field"
                rows="3"
                placeholder="ç•™ç©ºä½¿ç”¨é»˜è®¤æ¿€æƒ…é£æ ¼ã€‚æˆ–è‡ªå®šä¹‰ï¼šå¦‚'ä½ æ˜¯ä¸“ä¸šå†·é™çš„è§£è¯´å‘˜...'"
            ></textarea>
        </div>

        <!-- APIé…ç½® -->
        <div class="api-config-grid">
            <div class="field-group">
                <label class="field-label">API åœ°å€</label>
                <input id="gm_api_url" type="text" class="input-field" placeholder="https://api.openai.com/v1" />
            </div>
            <div class="field-group">
                <label class="field-label">
                    æ¨¡å‹
                    <button id="fetch_gm_models" class="icon-btn refresh-btn" title="æ‹‰å–æ¨¡å‹åˆ—è¡¨">
                        <span class="btn-icon">ğŸ”„</span>
                        <span class="btn-text">æ‹‰å–</span>
                    </button>
                </label>
                <select id="gm_model" class="input-field"></select>
            </div>
        </div>
        
        <div class="field-group">
            <label class="field-label">API Key</label>
            <input id="gm_api_key" type="password" class="input-field" placeholder="sk-..." />
        </div>
    </div>
    
    <!-- ç©å®¶é…ç½®åŒº -->
    <div class="settings-section players-section">
        <h3 class="section-title">
            <span class="title-icon">ğŸ‘¥</span>
            <span>ç©å®¶é…ç½®</span>
            <span class="player-count-badge">6ä½ç©å®¶</span>
        </h3>
        <div class="players-config" id="players_config_container">
            <!-- Player configs will be generated by JS -->
        </div>
    </div>
    
    <!-- ä¿å­˜æŒ‰é’® -->
    <div class="save-section">
        <button id="save_battle_settings" class="save-btn">
            <span class="btn-icon">ğŸ’¾</span>
            <span class="btn-text">ä¿å­˜é…ç½®</span>
        </button>
    </div>
</div>

<!-- ç©å®¶é…ç½®æ¨¡æ¿ -->
<template id="player_config_template">
    <div class="player-card">
        <div class="player-card-header">
            <div class="player-avatar">
                <span class="avatar-text">{PLAYER_NUM}</span>
            </div>
            <div class="player-title">
                <h4>ç©å®¶ {PLAYER_NUM}</h4>
                <span class="player-status">æœªé…ç½®</span>
            </div>
            <button class="collapse-btn" onclick="this.closest('.player-card').classList.toggle('collapsed')">
                <span class="collapse-icon">â–¼</span>
            </button>
        </div>
        
        <div class="player-card-body">
            <div class="field-group">
                <label class="field-label">æ¸¸æˆä¸­çš„åç§°</label>
                <input type="text" id="player{PLAYER_NUM}_name" class="input-field" placeholder="ä¾‹å¦‚ï¼šAI-Alpha">
            </div>
            
            <div class="field-group">
                <label class="field-label">API URL</label>
                <input type="text" id="player{PLAYER_NUM}_api_url" class="input-field" placeholder="https://api.openai.com/v1">
            </div>
            
            <div class="field-group">
                <label class="field-label">API Key</label>
                <input type="password" id="player{PLAYER_NUM}_api_key" class="input-field" placeholder="sk-...">
            </div>
            
            <div class="field-group">
                <label class="field-label">æ¨¡å‹</label>
                <div class="model-input-group">
                    <select id="player{PLAYER_NUM}_model" class="input-field"></select>
                    <button id="fetch_player{PLAYER_NUM}_models" class="icon-btn" title="æ‹‰å–æ¨¡å‹åˆ—è¡¨">
                        <span>ğŸ”„</span>
                    </button>
                    <button id="test_player{PLAYER_NUM}_api" class="icon-btn test-btn" title="æµ‹è¯•APIè¿æ¥">
                        <span>âœ“</span>
                    </button>
                </div>
            </div>
            
            <details class="advanced-section">
                <summary class="advanced-summary">
                    <span class="summary-icon">âš™ï¸</span>
                    <span>é«˜çº§ï¼šè‡ªå®šä¹‰äººæ ¼æç¤ºè¯ï¼ˆå¯é€‰ï¼‰</span>
                </summary>
                <div class="advanced-content">
                    <textarea 
                        id="player{PLAYER_NUM}_custom_prompt" 
                        class="input-field textarea-field" 
                        placeholder="ä¾‹å¦‚ï¼šä½ æ€§æ ¼è°¨æ…ï¼Œä¸è½»æ˜“ç›¸ä¿¡ä»–äºº..." 
                        rows="4"
                    ></textarea>
                </div>
            </details>
        </div>
    </div>
</template>

<style>
    /* ==================== CSSå˜é‡ç³»ç»Ÿ ==================== */
    :root {
        --primary-color: #667eea;
        --secondary-color: #764ba2;
        --accent-color: #f093fb;
        --success-color: #4caf50;
        --warning-color: #ff9800;
        --error-color: #f44336;
        --info-color: #2196f3;
        
        --bg-elevated: rgba(102, 126, 234, 0.08);
        --bg-glass: rgba(20, 20, 40, 0.6);
        --bg-hover: rgba(102, 126, 234, 0.15);
        
        --border-radius-sm: 6px;
        --border-radius-md: 10px;
        --border-radius-lg: 14px;
        
        --transition-fast: 0.15s cubic-bezier(0.4, 0, 0.2, 1);
        --transition-normal: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        
        --glow-primary: 0 0 20px rgba(102, 126, 234, 0.4);
        --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.2);
        --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.3);
        --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.4);
    }

    /* ==================== å®¹å™¨ ==================== */
    .battle-settings-container {
        max-height: 75vh;
        overflow-y: auto;
        padding: 20px;
        scrollbar-width: thin;
        scrollbar-color: var(--primary-color) rgba(0,0,0,0.2);
    }

    .battle-settings-container::-webkit-scrollbar {
        width: 10px;
    }

    .battle-settings-container::-webkit-scrollbar-track {
        background: rgba(0,0,0,0.2);
        border-radius: 5px;
    }

    .battle-settings-container::-webkit-scrollbar-thumb {
        background: linear-gradient(180deg, var(--primary-color), var(--secondary-color));
        border-radius: 5px;
    }

    /* ==================== æ ‡é¢˜åŒº ==================== */
    .settings-header {
        text-align: center;
        margin-bottom: 32px;
        animation: fadeInDown 0.5s ease-out;
    }

    .main-title {
        font-size: 32px;
        margin: 0 0 8px 0;
        background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        font-weight: bold;
    }

    .subtitle {
        color: #999;
        font-size: 14px;
        margin: 0;
    }

    /* ==================== è®¾ç½®åŒºå— ==================== */
    .settings-section {
        margin-bottom: 24px;
        padding: 20px;
        background: var(--bg-elevated);
        backdrop-filter: blur(10px);
        border-radius: var(--border-radius-lg);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-left: 3px solid var(--primary-color);
        box-shadow: var(--shadow-sm);
        transition: all var(--transition-normal);
        position: relative;
        overflow: hidden;
        animation: fadeInUp 0.5s ease-out backwards;
    }

    .settings-section:nth-child(2) { animation-delay: 0.1s; }
    .settings-section:nth-child(3) { animation-delay: 0.2s; }
    .settings-section:nth-child(4) { animation-delay: 0.3s; }
    .settings-section:nth-child(5) { animation-delay: 0.4s; }

    .settings-section::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.1), transparent);
        transition: left 0.6s;
    }

    .settings-section:hover {
        transform: translateY(-2px);
        border-left-color: var(--accent-color);
        box-shadow: 0 0 30px rgba(102, 126, 234, 0.25);
    }

    .settings-section:hover::before {
        left: 100%;
    }

    .section-title {
        display: flex;
        align-items: center;
        gap: 10px;
        margin: 0 0 16px 0;
        font-size: 18px;
        font-weight: bold;
        color: var(--SmartThemeBodyColor);
    }

    .title-icon {
        font-size: 20px;
        filter: drop-shadow(0 0 8px currentColor);
    }

    .section-description {
        font-size: 13px;
        color: #999;
        margin: 0 0 12px 0;
        line-height: 1.6;
    }

    /* ==================== è¡¨å•å…ƒç´  ==================== */
    .field-group {
        margin-bottom: 16px;
    }

    .field-label {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 6px;
        font-size: 13px;
        font-weight: 500;
        color: #ccc;
    }

    .input-field {
        width: 100%;
        padding: 10px 14px;
        background: rgba(0, 0, 0, 0.4);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: var(--border-radius-sm);
        color: var(--SmartThemeBodyColor);
        font-size: 14px;
        transition: all var(--transition-normal);
        font-family: inherit;
    }

    .input-field:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2), var(--glow-primary);
        transform: scale(1.01);
    }

    .textarea-field {
        resize: vertical;
        min-height: 80px;
        line-height: 1.6;
    }

    /* ==================== ä¿¡æ¯æ¡† ==================== */
    .info-box {
        margin-top: 12px;
        padding: 12px;
        background: rgba(0, 0, 0, 0.3);
        border-radius: var(--border-radius-md);
        border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .info-item {
        display: flex;
        gap: 12px;
        padding: 8px 0;
    }

    .info-item:not(:last-child) {
        border-bottom: 1px dashed rgba(255, 255, 255, 0.1);
    }

    .info-icon {
        font-size: 20px;
        flex-shrink: 0;
    }

    .info-item strong {
        display: block;
        color: var(--SmartThemeBodyColor);
        margin-bottom: 4px;
    }

    .info-item p {
        font-size: 12px;
        color: #999;
        margin: 0;
        line-height: 1.5;
    }

    /* ==================== åˆ‡æ¢å¼€å…³ ==================== */
    .commentator-toggle {
        margin-bottom: 16px;
        padding: 12px;
        background: rgba(0, 0, 0, 0.3);
        border-radius: var(--border-radius-md);
    }

    .toggle-label {
        display: flex;
        align-items: center;
        gap: 12px;
        cursor: pointer;
        user-select: none;
    }

    .toggle-checkbox {
        display: none;
    }

    .toggle-switch {
        position: relative;
        width: 48px;
        height: 24px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        transition: all var(--transition-normal);
        flex-shrink: 0;
    }

    .toggle-switch::after {
        content: '';
        position: absolute;
        top: 2px;
        left: 2px;
        width: 20px;
        height: 20px;
        background: white;
        border-radius: 50%;
        transition: all var(--transition-normal);
        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }

    .toggle-checkbox:checked +
