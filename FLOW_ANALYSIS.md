# AI 策略对战扩展 - 通用游戏流程分析

## 关键设计原则与注意事项

1.  **禁止在扩展代码中硬编码任何游戏规则**：
    *   本扩展是一个**通用框架**，不应包含任何特定游戏（如“狼人杀”）的逻辑。
    *   所有游戏规则、角色、流程都必须由**酒馆AI（GM）通过世界书和聊天上下文**来驱动。扩展只负责解析和执行指令。

2.  **流程必须是通用的**：
    *   本流程适用于任何需要AI玩家轮流行动、并可能包含秘密信息的游戏。
    *   扩展的核心功能是作为GM和AI玩家之间的“协调者”和“指令解析器”，而不是“游戏裁判”。

---

## 完整通用游戏流程

### 【阶段 1：游戏初始化（用户与GM交互）】

1.  **用户输入游戏名称**：
    *   用户在酒馆聊天框中输入一个关键词，如“狼人杀”、“密室逃脱”等。

2.  **触发世界书条目**：
    *   该关键词触发一个预设的世界书条目，将其内容（包含游戏规则、背景、指令格式等）注入到酒馆AI（GM）的上下文中。

3.  **GM生成开场白**：
    *   GM读取注入的上下文，并自动生成一段回复，内容通常包括：
        *   游戏开场白和背景介绍。
        *   介绍参与游戏的AI选手。
        *   **详细说明游戏规则**。
        *   **明确定义指令格式**，例如：
            *   公开行动指令：`【轮到：玩家名】`
            *   秘密信息指令：`【秘密指示：玩家名|秘密内容】`
        *   分配初始身份或状态（通常使用秘密指示）。
        *   发出第一个行动指令，开始游戏的第一步。

    *   **至此，所有游戏规则和指令格式都已存在于聊天记录中。**

### 【阶段 2：扩展接管（用户点击“开始游戏”）】

4.  **用户点击“开始游戏”按钮**：
    *   触发扩展的 `startGame()` 函数。
    *   扩展正式开始作为“协调者”介入游戏。

5.  **扩展读取上下文**：
    *   扩展调用 `getChatContext()` 函数，获取包含GM开场白在内的近期聊天记录。
    *   此时，扩展的“视野”里已经有了完整的游戏规则和指令格式。

6.  **扩展发送第一个触发消息**：
    *   扩展调用 `callGM()`，向GM发送一条**通用、中立**的触发消息。
    *   **目的**：提示GM根据**已有的聊天上下文**继续主持游戏。
    *   **示例消息**：`“请根据当前聊天记录和游戏规则，继续主持游戏。”`

### 【阶段3：游戏主循环（扩展协调）】

7.  **GM回复指令**：
    *   GM根据上下文，回复一条包含行动指令的消息，如 `“黑夜过去了，现在【轮到：AI-Alpha】发言。”`

8.  **扩展解析指令**：
    *   扩展捕获GM回复中的指令（`【轮到：...】` 或 `【秘密指示：...】`）。
    *   如果GM回复不包含有效指令，扩展会发送一条提示消息，要求GM使用正确的格式。

9.  **扩展调用玩家AI**：
    *   如果解析出 `【轮到：玩家名】`，扩展会调用 `callPlayerAI()`。
    *   **构建提示词**：将**公开聊天记录（`getChatContext()`）**和**该玩家的秘密信息（`playerSecrets`）**组合成一个完整的提示词。
    *   玩家AI根据提示词生成行动或发言。

10. **AI回复插入聊天**：
    *   玩家AI的回复通过 `appendToChat()` 函数被添加回酒馆的聊天记录中，所有参与者可见。

11. **暂停并等待用户操作**：
    *   为了让用户能控制游戏节奏，扩展在每次行动后会自动暂停，并激活“继续游戏”按钮。

12. **循环继续**：
    *   用户点击“继续游戏”。
    *   扩展再次调用 `callGM()` 发送通用触发消息（返回第6步），让GM根据最新的聊天记录判断下一步行动。
    *   此循环一直持续，直到GM在回复中包含“游戏结束”的标志。
