# 🎮 AI策略对战扩展 - 完整项目文档

> **版本**: 2.1 双模式版  
> **最后更新**: 2025-11-10  
> **核心理念**: 支持通用模式（世界书驱动）和专用模式（狼人杀内置引擎）

---

## 📋 目录

1. [项目简介](#项目简介)
2. [核心特性](#核心特性)
3. [系统架构](#系统架构)
4. [完整游戏流程](#完整游戏流程)
5. [安装与配置](#安装与配置)
6. [使用指南](#使用指南)
7. [技术实现](#技术实现)
8. [问题修复记录](#问题修复记录)
9. [扩展性说明](#扩展性说明)
10. [故障排除](#故障排除)

---

## 项目简介

**AI策略对战扩展** 是一个为 SillyTavern 设计的创新扩展，它允许多个AI玩家在复杂的游戏规则下进行策略对抗和智力角逐。核心是让每一个行动都是**ai自发决策**

### 🎯 核心设计理念：世界书驱动

这个系统的根本设计思想是 **"世界书驱动"**：

- **游戏规则在世界书中定义**：扩展代码本身是通用的，不包含任何特定游戏的逻辑
- **扩展只是协调者**：解析GM指令，协调AI玩家轮流行动
- **GM（酒馆AI）是主持人**：读取世界书规则并主持游戏
- **无需修改代码**：添加新游戏只需创建新的世界书

### 🌟 两种运行模式

#### 🎯 通用模式（世界书驱动）
- **狼人杀**：通过世界书定义规则，GM主持
- **阿瓦隆**：任务投票、身份猜测
- **三国杀**：技能释放、回合制对战
- **密室逃脱**：线索收集、谜题解答
- **自定义游戏**：任何需要AI协作/对抗的场景

#### 🐺 狼人杀专用模式（内置引擎）
- **无需GM API**：程序自动主持游戏
- **严格回合制**：夜晚→白天循环
- **自动角色分配**：狼人、预言家、女巫、村民
- **完整游戏逻辑**：投票、技能、胜负判定
- **更稳定可靠**：不依赖AI理解指令格式

---

## 核心特性

### 🤖 多AI对战系统

#### 独立配置
- ✅ 支持配置6个独立AI玩家
- ✅ 每个AI拥有独立的API配置（URL、Key、模型）
- ✅ 为每个AI定制独特的人格特征
- ✅ AI之间的秘密信息完全隔离

#### GM独立配置（v2.0新增）
- ✅ GM使用独立的API配置
- ✅ 支持为GM选择更强大的模型（如GPT-4）
- ✅ 可自定义GM系统提示词
- ✅ 一键拉取可用模型列表

### 🎭 双引擎架构（v2.1新增）

#### 通用游戏引擎（UniversalGameEngine）
适用于任意游戏，通过解析GM的标准化指令来协调：

```
【轮到：玩家名】        → 让指定AI公开行动
【秘密指示：玩家名|内容】 → 给指定AI发送秘密信息
游戏结束               → 终止游戏循环
```

**优点**：灵活，可玩任何游戏  
**缺点**：依赖GM理解指令格式，可能出错

#### 狼人杀专用引擎（WerewolfGameEngine）
内置完整的狼人杀游戏逻辑，不依赖GM：

```javascript
class WerewolfGameEngine {
    // 自动执行：
    - 随机分配角色（狼人×2、预言家、女巫、村民×2）
    - 夜晚阶段（狼人行动、预言家查验、女巫救人）
    - 白天阶段（公布死亡、所有人发言、投票驱逐）
    - 胜利判定（狼人全灭/好人≤狼人）
}
```

**优点**：稳定可靠，不会出错  
**缺点**：只能玩狼人杀

#### 模式选择
在扩展设置中，顶部有"游戏模式"下拉框：
- 选择"通用模式" → 使用 UniversalGameEngine
- 选择"狼人杀模式" → 使用 WerewolfGameEngine

#### 信息隔离
- **公开信息**：所有AI都能看到的聊天记录
- **秘密信息**：每个AI独有的秘密情报队列
- **GM视角**：完整上下文，包括所有历史记录

### ⏸️ 暂停与控制系统

#### 暂停机制
- 游戏在每个AI行动后自动暂停
- 用户可查看当前状态和AI发言
- 点击"继续游戏"推进下一步

#### 采访系统
- 在暂停时可采访任何AI
- AI根据其角色和秘密情报回答
- 了解AI的真实想法和推理过程
- 采访内容不会进入游戏上下文

### 🎙️ AI解说员（v2.2新增）

为了增加狼人杀模式的观赏性和趣味性，引入了AI解说员功能。

#### 特性
- **激情解说**：在游戏的关键节点（如夜晚开始、公布死讯、投票后），AI解说员会自动生成富有激情的解说，渲染游戏气氛。
- **智能防剧透**：解说员只会基于公开信息进行评论，绝不会泄露角色身份、夜晚行动等秘密信息。
- **风格可定制**：
    - **默认风格**：内置“激情澎湃”的解说风格。
    - **自定义风格**：用户可以在设置中提供自己的提示词，创造出“冷静分析型”、“幽默吐槽型”等任意风格的解说员。
- **独立开关**：可以在设置中随时启用或禁用此功能。

#### 实现方式
- **复用GM配置**：解说员API调用复用GM的API配置，无需额外设置。
- **关键节点触发**：在`WerewolfGameEngine`的`nightPhase`、`dayPhase`等关键流程节点中，调用`callCommentator`方法来生成解说。

### 📊 实时监控面板

#### 📺 实时游戏流程面板 (v2.3 新增)
为了让用户能更直观地追踪狼人杀模式的每一个细节，我们增加了实时游戏流程面板。

- **双栏布局**：
    - **左侧公开消息**：显示所有玩家可见的系统公告、玩家发言、投票结果等。
    - **右侧私密消息**：显示特定玩家或阵营才能看到的秘密信息，如身份分配、狼人夜间讨论、预言家查验结果等。
- **参与者标注**：每条私密消息都会清晰地标注出可以看到该消息的玩家。
- **完整历史导出**：游戏结束后，可以点击【导出完整历史到酒馆】按钮，将本次对局的所有公开和私密消息按时间顺序完整地插入到当前酒馆聊天中，方便复盘和分享。

#### 游戏状态
- 当前游戏状态（运行中/暂停中/已结束）
- 当前回合数
- 正在行动的玩家

#### 玩家状态
- 每个玩家的活跃状态
- 是否拥有秘密信息
- 最近的行动记录

#### GM调试信息
- GM的触发消息
- 上下文长度统计
- GM原始回复预览
- 解析出的指令
- 秘密信息队列状态

#### 提示词记录
- 实时显示发送给每个AI的完整提示词
- 查看AI的完整回复
- 折叠/展开详细内容
- 帮助理解AI决策过程

### 🎨 浮动UI面板

#### 界面特性
- 浮动在聊天界面右侧
- 可拖动到任意位置
- 可折叠/展开各个区块
- 支持大小面板模式切换
- 不占用扩展设置空间

#### 大小面板模式
- **小面板模式**：260px宽，适合日常监控
- **大面板模式**：80vw宽，屏幕中央，适合详细分析

---

## 系统架构

### 🏗️ 架构层次

```
┌─────────────────────────────────────────┐
│         用户交互层 (UI)                    │
│  - 设置面板                               │
│  - 浮动控制台                             │
│  - 采访界面                               │
└─────────────────────────────────────────┘
                    ↕
┌─────────────────────────────────────────┐
│      游戏协调层 (UniversalGameEngine)     │
│  - 游戏循环管理                           │
│  - 指令解析                               │
│  - 秘密信息管理                           │
└─────────────────────────────────────────┘
                    ↕
┌─────────────────────────────────────────┐
│         API通信层 (callGM / callPlayerAI) │
│  - GM API 调用                            │
│  - 玩家AI API调用                         │
│  - 提示词构建                             │
└─────────────────────────────────────────┘
                    ↕
┌─────────────────────────────────────────┐
│        SillyTavern集成层                  │
│  - 聊天记录读写 (getContext)              │
│  - 消息插入 (appendToChat)                │
│  - 世界书触发                             │
└─────────────────────────────────────────┘
```

### 🔑 核心类

#### UniversalGameEngine（通用引擎）

```javascript
class UniversalGameEngine {
    constructor(settings) {
        this.gmSystemPrompt     // GM系统提示词
        this.gmApiUrl           // GM API地址
        this.gmApiKey           // GM API密钥
        this.gmModel            // GM使用的模型
        this.apiConfigs         // 玩家API配置映射
        this.playerSecrets      // 玩家秘密信息队列
        this.running            // 游戏运行状态
        this.paused             // 游戏暂停状态
    }
    
    // 核心方法
    async callGM(userMessage)              // 调用GM API
    async callPlayerAI(playerId, includeSecret) // 调用玩家AI
    addSecret(playerId, secretInfo)        // 添加秘密信息
    getChatContext()                       // 获取公开上下文
    appendToChat(speaker, message)         // 插入消息到聊天
    async startGame()                      // 游戏主循环
    findPlayerByName(name)                 // 模糊匹配玩家名
}
```

#### WerewolfGameEngine（狼人杀引擎）

```javascript
class WerewolfGameEngine {
    constructor(settings, appendToChat, callAI) {
        this.players            // 玩家列表（从settings读取）
        this.roles              // 角色分配 {playerId: 'werewolf'/'villager'...}
        this.alive              // 存活玩家集合
        this.nightActions       // 夜晚行动记录
        this.dayNum             // 当前天数
        this.appendToChat       // 聊天插入函数（由index.js传入）
        this.callAI             // AI调用函数（由index.js传入）
    }
    
    // 核心方法
    async startGame()           // 游戏主流程
    assignRoles()               // 随机分配角色
    async nightPhase()          // 夜晚阶段
    async dayPhase()            // 白天阶段
    async executeVote()         // 执行投票
    checkVictory()              // 检查胜利条件
    parseAction(text, format)   // 解析AI回复
}
```

### 📦 关键数据结构

#### 玩家配置 (apiConfigs)
```javascript
{
    'p1': {
        name: 'AI-Alpha',
        url: 'https://api.openai.com/v1',
        key: 'sk-...',
        model: 'gpt-4',
        customPrompt: '你性格谨慎...'
    },
    // ...更多玩家
}
```

#### 秘密信息队列 (playerSecrets)
```javascript
{
    'p1': [
        '你的身份是狼人',
        '你的队友是AI-Beta',
        'AI-Gamma是预言家'
    ],
    'p2': [...],
    // ...
}
```

---

## 完整游戏流程

### 📌 流程分支：两种模式

根据用户在设置中选择的"游戏模式"，启动流程会有所不同：

---

## 🎯 通用模式流程

### 🎬 阶段0：准备阶段（用户操作）

**目标**：让GM知道要玩什么游戏，并加载规则

#### 步骤1：用户输入关键词
```
用户在酒馆聊天框输入：狼人杀
```

#### 步骤2：世界书激活
- 酒馆检测到关键词"狼人杀"
- 对应的世界书条目被激活
- 其内容被注入到GM的上下文中

#### 步骤3：GM加载规则并开场
GM根据世界书内容生成开场白：
```
🎮 GM: 好的，各位智慧体！欢迎来到《狼人杀》的逻辑战场。
今晚的参与者有：AI-Alpha、AI-Beta、AI-Gamma、AI-Delta、AI-Echo、AI-Foxtrot

【游戏规则】
- 角色：狼人×2、村民×2、预言家×1、女巫×1
- 狼人目标：杀光所有好人
- 好人目标：找出并驱逐所有狼人
...

【指令格式】
- 公开行动：【轮到：玩家名】
- 秘密信息：【秘密指示：玩家名|内容】

现在，天黑请闭眼...
```

**重要**：到此为止，所有操作都和扩展无关，完全是酒馆和世界书的机制。

---

### 🚀 阶段1：启动扩展（用户操作）

**目标**：让扩展接管协调工作

#### 步骤1：用户点击"开始游戏"
用户在浮动面板上点击 **▶️ 开始游戏**

#### 步骤2：扩展初始化
```javascript
// 创建游戏引擎实例
gameEngine = new UniversalGameEngine(settings);

// 初始化UI
window.updateGameStatus('运行中', 0, 'GM准备中');
window.updatePlayersList(initialPlayers);
```

#### 步骤3：扩展发送触发消息
扩展调用GM，告诉GM扩展已准备就绪：
```javascript
await callGM(`扩展已启动，请根据聊天记录中的规则和当前游戏状态，继续主持游戏。`);
```

#### 步骤4：GM分配身份
GM收到触发消息，开始执行游戏第一步：
```
🎮 GM: 好的，现在我将秘密分配身份...
【秘密指示：AI-Alpha|你的身份是狼人，队友是AI-Beta】
【秘密指示：AI-Beta|你的身份是狼人，队友是AI-Alpha】
【秘密指示：AI-Gamma|你的身份是预言家】
【秘密指示：AI-Delta|你的身份是村民】
【秘密指示：AI-Echo|你的身份是女巫】
【秘密指示：AI-Foxtrot|你的身份是村民】

身份分配完毕。现在狼人请睁眼...
【轮到：AI-Alpha】
```

---

### 🔄 阶段2：游戏主循环

**核心循环逻辑**：

```javascript
while (游戏进行中) {
    1. 扩展询问GM："请继续主持游戏"
    2. GM回复指令（轮到谁/秘密指示）
    3. 扩展解析指令
       - 如果是【秘密指示】 → 存入playerSecrets，不显示原文
       - 如果是【轮到：玩家名】 → 调用对应AI
    4. AI生成回复并插入聊天
    5. 扩展暂停，等待用户点击"继续"
    6. 用户点击"继续" → 回到步骤1
}
```

**详细步骤**：

1. **扩展发送触发**：`"请继续主持游戏，判断下一步行动"`
2. **GM回复指令**：例如 `"【轮到：AI-Alpha】请发言"`
3. **扩展解析**：提取玩家名"AI-Alpha"
4. **构建提示词**：
   ```
   [人格设定]
   你性格谨慎，不轻易相信他人...
   
   [公开信息]
   （最近50条聊天记录）
   
   [秘密信息 - 其他玩家看不到]
   你的身份是狼人
   你的队友是AI-Beta
   ```
5. **AI回复**：`"我观察了大家的发言，我怀疑AI-Gamma可能是预言家..."`
6. **插入聊天**：所有人可见
7. **暂停游戏**：等待用户继续

---

### 🏁 阶段3：游戏结束

GM回复包含"游戏结束" → 扩展检测到 → 停止循环 → 重置所有状态

---

## 🐺 狼人杀专用模式流程

### 🎬 启动流程（完全自动化）

**无需世界书，无需GM API，点击"开始游戏"即可！**

#### 步骤1：用户点击"开始游戏"

在设置中选择"狼人杀模式"后，点击浮动面板的"▶️ 开始游戏"。

#### 步骤2：创建狼人杀引擎

```javascript
gameEngine = new WerewolfGameEngine(
    settings,           // 玩家配置
    appendToChat,       // 聊天插入函数
    callAI              // AI调用函数
);
```

#### 步骤3：随机分配角色

```javascript
// 系统自动分配（玩家不可见）
roles = {
    'p1': 'werewolf',    // AI-Alpha是狼人
    'p2': 'werewolf',    // AI-Beta是狼人
    'p3': 'seer',        // AI-Gamma是预言家
    'p4': 'witch',       // AI-Delta是女巫
    'p5': 'villager',    // AI-Echo是村民
    'p6': 'villager'     // AI-Foxtrot是村民
}
```

#### 步骤4：发送角色通知

```
🎮 系统: 游戏开始！角色已秘密分配。
🎮 系统: 第1夜降临...
```

---

### 🌙 夜晚阶段流程

#### 1️⃣ 狼人行动

系统给两个狼人发送提示词：

```
[你的角色]
你是狼人。你的目标是消灭所有好人。

[狼人队友]
- AI-Beta（也是狼人）

[当前存活玩家]
- AI-Alpha（你自己）
- AI-Beta（狼人队友）
- AI-Gamma
- AI-Delta
- AI-Echo
- AI-Foxtrot

[当前任务]
请选择今晚要攻击的目标。
回复格式：攻击：目标名字

例如：攻击：AI-Gamma
```

**AI回复示例**：
```
AI-Alpha: 攻击：AI-Gamma
```

**系统解析**：
- 提取目标"AI-Gamma"
- 记录到 `nightActions.werewolfTarget = 'AI-Gamma'`
- **不公开显示**（其他玩家不知道）

#### 2️⃣ 预言家查验

系统给预言家发送提示词：

```
[你的角色]
你是预言家。每晚你可以查验一名玩家的身份。

[当前存活玩家]
- AI-Alpha
- AI-Beta
- AI-Gamma（你自己）
- AI-Delta
- AI-Echo
- AI-Foxtrot

[当前任务]
请选择今晚要查验的玩家。
回复格式：查验：目标名字
```

**AI回复示例**：
```
AI-Gamma: 查验：AI-Alpha
```

**系统处理**：
- 检查AI-Alpha的身份 → 狼人
- 给预言家反馈：`查验结果：AI-Alpha是狼人！`
- 此信息只有预言家知道

#### 3️⃣ 女巫行动

系统给女巫发送提示词：

```
[你的角色]
你是女巫。你有解药（救人）和毒药（杀人）各一瓶。

[今晚的情况]
今晚狼人攻击了：AI-Gamma

[你的道具]
- 解药：已使用/未使用
- 毒药：已使用/未使用

[当前任务]
1. 是否使用解药救AI-Gamma？
2. 是否使用毒药杀死某人？

回复格式：
- 使用解药
- 不使用解药
- 使用毒药：目标名字
- 不使用毒药
```

**AI回复示例**：
```
AI-Delta: 使用解药
不使用毒药
```

**系统处理**：
- 标记AI-Gamma被救活
- 记录解药已使用

---

### ☀️ 白天阶段流程

#### 1️⃣ 公布夜晚结果

```
🎮 系统: 天亮了...
🎮 系统: 昨晚，AI-Gamma被狼人攻击，但被女巫救活！
🎮 系统: 没有人死亡。
```

**或者**（如果女巫没救）：
```
🎮 系统: 昨晚，AI-Gamma被狼人杀害！
🎮 系统: 请AI-Gamma退出游戏。
```

#### 2️⃣ 所有存活玩家轮流发言

系统依次调用每个存活的AI，给他们发送提示词：

```
[你的角色]
你是狼人。

[当前公开信息]
（聊天历史，包括所有人的发言）

[你的秘密情报]
- 你的队友：AI-Beta
- 预言家查验结果：AI-Alpha是狼人

[当前存活玩家]
- AI-Alpha（你）
- AI-Beta（狼人队友）
- AI-Delta
- AI-Echo
- AI-Foxtrot

[当前任务]
现在是发言阶段。请根据已有信息进行推理和发言。
你可以：
1. 分析可疑对象
2. 为队友辩护或指控他人
3. 分享你的"观察"（注意不要暴露身份）
```

**AI发言示例**：
```
AI-Alpha: 我观察到AI-Echo的发言很可疑，他一直在试图引导投票方向。
我怀疑他可能是狼人。
```

**系统处理**：
- 将发言插入酒馆聊天
- 所有人可见
- 进入下一个玩家发言

#### 3️⃣ 投票驱逐

所有玩家发言完毕后，系统组织投票：

```
🎮 系统: 发言结束，现在开始投票驱逐！
```

系统给每个存活玩家发送提示词：

```
[当前情况]
所有人已发言完毕。

[当前存活玩家]
- AI-Alpha
- AI-Beta
- AI-Delta
- AI-Echo
- AI-Foxtrot

[你的秘密情报]
（你的角色信息）

[当前任务]
请投票选择你认为是狼人的玩家。
回复格式：投票：目标名字

例如：投票：AI-Echo
```

**AI投票示例**：
```
AI-Alpha: 投票：AI-Echo
AI-Beta: 投票：AI-Echo
AI-Delta: 投票：AI-Alpha
AI-Echo: 投票：AI-Alpha
AI-Foxtrot: 投票：AI-Echo
```

**系统统计投票**：
```
🎮 系统: 投票结果：
- AI-Alpha: 2票（AI-Delta、AI-Echo）
- AI-Echo: 3票（AI-Alpha、AI-Beta、AI-Foxtrot）

🎮 系统: AI-Echo被投票驱逐！请AI-Echo退出游戏。
```

#### 4️⃣ 检查胜利条件

```javascript
const werewolves = alive.filter(p => roles[p] === 'werewolf').length;
const goodGuys = alive.length - werewolves;

if (werewolves === 0) {
    // 好人胜利
    return '游戏结束！好人阵营获胜！';
}
if (werewolves >= goodGuys) {
    // 狼人胜利
    return '游戏结束！狼人阵营获胜！';
}
// 否则继续下一夜
```

---

### 🔄 循环与结束

如果游戏未结束，进入下一个夜晚：

```
🎮 系统: 第2夜降临...
```

重复夜晚→白天流程，直到：
- 狼人全部出局 → 好人胜利
- 狼人数量 ≥ 好人数量 → 狼人胜利

---

### 📊 狼人杀模式完整流程图

```
开始游戏
  ↓
随机分配角色（狼人×2、预言家、女巫、村民×2）
  ↓
┌─────────────────────────────┐
│      第N夜（Night Phase）      │
├─────────────────────────────┤
│ 1. 狼人选择攻击目标            │
│ 2. 预言家查验玩家              │
│ 3. 女巫决定是否救人/毒人        │
└─────────────────────────────┘
  ↓
⏸️ 暂停 - 用户可采访AI
  ↓
┌─────────────────────────────┐
│      第N天（Day Phase）        │
├─────────────────────────────┤
│ 1. 公布夜晚死亡结果            │
│ 2. 存活玩家轮流发言            │
│ 3. 所有人投票驱逐              │
│ 4. 公布投票结果                │
└─────────────────────────────┘
  ↓
⏸️ 暂停 - 用户可采访AI
  ↓
检查胜利条件
  ├─ 狼人全灭？ → 好人胜利 🎉
  ├─ 狼人≥好人？ → 狼人胜利 🎉
  └─ 否则 → 进入第N+1夜
```

---

### 🎯 狼人杀模式 vs 通用模式对比

| 特性 | 狼人杀专用模式 | 通用模式 |
|------|--------------|---------|
| **GM API** | ❌ 不需要 | ✅ 必需 |
| **世界书** | ❌ 不需要 | ✅ 必需 |
| **角色分配** | ✅ 自动随机 | 依赖GM |
| **游戏流程** | ✅ 严格回合制 | 依赖GM |
| **胜利判定** | ✅ 程序自动 | 依赖GM |
| **稳定性** | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ |
| **灵活性** | ⭐（只能玩狼人杀） | ⭐⭐⭐⭐⭐（可玩任何游戏） |
| **AI理解要求** | 低（只需说"攻击：XXX"） | 高（需理解复杂规则） |
| **适用场景** | 想玩稳定的狼人杀 | 想玩各种自定义游戏 |

---

## 安装与配置

### 📦 安装

1. 复制 `ai-strategy-battle` 文件夹到：
   ```
   SillyTavern/public/scripts/extensions/third-party/
   ```
2. 重启 SillyTavern
3. 在扩展设置中找到"🎮 AI策略对战"

### ⚙️ GM配置

- **API地址**：`https://api.openai.com/v1`
- **API密钥**：填入您的密钥
- **模型**：建议 `gpt-4` 或 `gpt-4-turbo`
- **系统提示词**：定义GM风格（可选）

### 🎭 玩家配置

为每个玩家设置：
- **名称**：AI-Alpha ~ AI-Foxtrot
- **API配置**：URL、密钥、模型
- **人格**：可选，如"你性格谨慎..."

---

## 使用指南

### 开始游戏

1. 在聊天框输入游戏关键词（如"狼人杀"）
2. 等待GM开场
3. 点击"▶️ 开始游戏"

### 控制游戏

- **⏭️ 继续游戏**：推进下一步
- **⏹️ 停止游戏**：终止并重置
- **🎤 采访AI**：选择AI并提问

---

## 技术实现

### 核心技术点

#### 1. 指令解析（正则表达式）
```javascript
// 秘密指示（支持多条）
const secrets = [...text.matchAll(/【秘密指示[：:]\s*(.+?)\s*[|｜]\s*(.+?)】/g)];

// 公开行动
const action = text.match(/【轮到[：:]\s*(.+?)】/);
```

#### 2. 提示词构建
```javascript
let prompt = '';
if (customPrompt) prompt += `[人格设定]\n${customPrompt}\n\n`;
prompt += `[公开信息]\n${getChatContext()}\n\n`;
if (hasSecrets) prompt += `[秘密信息]\n${secrets.join('\n')}`;
```

#### 3. 消息实时显示
```javascript
appendToChat(speaker, message) {
    context.chat.push({name: speaker, mes: message, ...});
    setTimeout(() => updateMessageBlock(index, message), 0);
    context.saveChat();
}
```

#### 4. 异步游戏循环
```javascript
async startGame() {
    while (this.running) {
        const gmReply = await this.callGM('继续游戏');
        await this.parseAndExecute(gmReply);
        this.paused = true;
        await this.waitForResume();
    }
}
```

---

## 问题修复记录

### 🐛 Bug #1: GM胡乱回复问题（2025-11-09修复）

**问题描述**：  
GM没有按照游戏规则回复，而是回答了完全无关的内容（如B Corp认证说明）。

**根本原因**：  
GM的上下文中没有包含足够的游戏规则信息，导致GM"忘记"了自己在主持游戏。

**解决方案**：  
1. **加强GM系统提示词**：
   ```javascript
   extension_settings.gmSystemPrompt = `你是AI策略对战游戏的主持人（GM）。
   你的职责是：
   1. 根据聊天记录中的游戏规则主持游戏
   2. 使用【轮到：玩家名】指定下一个行动的玩家
   3. 使用【秘密指示：玩家名|内容】发送秘密信息
   4. 保持游戏流程的连贯性
   
   重要：你必须严格按照已有的游戏规则和指令格式行事。`;
   ```

2. **增强触发消息**：
   ```javascript
   const trigger = `请继续主持游戏，判断下一步行动。
   提醒：请使用【轮到：玩家名】或【秘密指示：玩家名|内容】格式。`;
   ```

3. **增加上下文长度**：将 `getChatContext()` 从30条增加到50条

4. **添加格式检测**：如果GM回复不包含指令，提示GM使用正确格式

---

### 🐛 Bug #2: 游戏面板UI及消息显示问题（2025-11-10修复）

**问题描述**：
1.  **消息不显示**：游戏开始后，实时游戏流程面板（公开/私密）没有任何内容更新。
2.  **状态不明确**：用户无法判断AI是在思考还是游戏卡住了。
3.  **UI体验差**：面板字体太小（10-11px），颜色对比度低，长时间观看眼睛疲劳。

**根本原因**：
1.  **DOM未清空**：`startGame` 函数虽然清空了 `gameMessages` 数组，但没有清空DOM中已存在的占位符 `<div>`（"等待游戏开始..."），导致新消息被追加到了占位符后面，视觉上不可见。
2.  **缺少状态反馈**：在调用AI的异步函数 `callPlayerAI` 中，没有在请求发出前和收到响应后更新UI状态的逻辑。
3.  **CSS样式问题**：`style.css` 中字体大小和颜色值设置不佳。

**解决方案**：
1.  **修复消息显示** (`index.js`):
    - 在 `startGame()` 函数中，调用 `clearGameHistory()` 后，强制通过 `innerHTML = ''` 清空 `#publicMessages` 和 `#privateMessages` 两个DOM容器。
    - 同时，在清空后立即添加一条 "游戏初始化中..." 的系统消息，提供即时反馈。

2.  **增强状态提示** (`index.js`):
    - 在 `callPlayerAI()` 函数的开头，增加 `window.addPublicMessage` 和 `window.updateGameStatus` 调用，向UI面板和消息流中注入 "⏳ [玩家名] 正在思考..." 的状态提示。
    - 在API调用失败的 `catch` 块中，同样增加消息提示，告知用户哪个AI响应失败。

3.  **美化UI样式** (`style.css`):
    - **完全重写 `style.css`**。
    - **增大字体**：将消息内容和发言者姓名的字体大小统一提升到 `14px`，时间戳等辅助信息提升到 `11px-12px`。
    - **提高对比度**：将消息内容的颜色从 `#CCC` 改为 `#FFFFFF`（纯白），时间戳颜色从 `#666` 改为 `#999`。
    - **优化布局**：增加了 `padding` 和 `margin`，使布局更宽松。
    - **增加细节**：添加了 `box-shadow`、鼠标悬停效果和自定义美化滚动条，提升整体视觉效果。

---

### 🐛 Bug #3: 狼人杀模式流程卡顿与反馈缺失（2025-11-10深夜修复）

**问题描述**：
1.  **流程卡顿**：在狼人杀模式的白天发言环节，游戏在第一个玩家发言后就暂停，不会自动让下一位玩家继续，不符合预期。
2.  **反馈缺失**：
    *   “AI正在思考...”的提示在狼人杀模式下完全不显示。
    *   狼人夜间讨论过程不可见，用户只能看到“狼人请睁眼”和最终结果，无法了解其决策过程。
3.  **调试困难**：控制台日志不够清晰，难以追踪游戏阶段。

**根本原因**：
1.  **暂停逻辑错误**：在 `werewolf-engine.js` 的 `playersSpeech` 方法中，`this.paused = true; await this.waitForResume();` 被错误地放置在了 `for` 循环内部，导致每位玩家发言后都暂停了整个游戏。
2.  **状态提示未覆盖**：`index.js` 中，传递给 `WerewolfGameEngine` 的 `callPlayerAIFn` 匿名函数没有包含显示“思考中”状态的 `addPublicMessage` 调用。
3.  **讨论机制缺失**：`werewolvesAction` 方法只是简单地收集每个狼人的投票，没有设计一个让他们依次发言、形成讨论的循环。
4.  **日志粒度不足**：关键的游戏阶段转换（如夜晚开始/结束，白天开始/结束）没有明确的控制台日志分割线。

**解决方案**：
1.  **修复流程卡顿** (`werewolf-engine.js`):
    - 将 `playersSpeech` 方法中的暂停代码 (`this.paused = true; await this.waitForResume();`) 从 `for` 循环中移出，确保所有玩家都发言完毕后，游戏才暂停一次等待用户确认进入投票环节。

2.  **补全状态提示** (`index.js`):
    - 修改了 `startGame` 函数中传递给 `WerewolfGameEngine` 的 `callPlayerAIFn` 匿名函数。
    - 在 `fetch` 调用前，插入 `window.addPublicMessage('⏳ 系统', \`\${config.name} 正在思考...\`);` 来显示状态。
    - 在 `catch` 块中也增加了相应的失败提示。

3.  **实现狼人讨论** (`werewolf-engine.js`):
    - **重写 `werewolvesAction` 方法**，引入了讨论循环。
    - 现在，狼人会**依次发言**，每个狼人的发言都会通过 `addPrivateMessage` 显示在私密消息频道中，供其他狼人参考。
    - 每个狼人发言时，都会看到前面狼人的讨论历史。
    - AI被要求在发言最后必须用 "我投票给：XXX" 的格式来明确投票，系统会解析此投票来决定最终目标。

4.  **增强控制台日志** (`werewolf-engine.js`):
    - 在 `startNightPhase` 和 `startDayPhase` 等关键函数的开头和结尾，添加了 `console.log` 分割线，如 `============== [狼人杀][NIGHT 1] START ==============`，使调试信息在控制台中一目了然。

---

## 扩展性说明

### 添加新游戏

扩展支持任何游戏，无需修改代码。步骤：

1. **创建世界书**：
   - 关键词：游戏名称
   - 内容：规则、角色、流程、指令格式

2. **在酒馆输入关键词**：触发世界书

3. **开始游戏**：扩展自动适配

### 示例：添加"阿瓦隆"

创建世界书条目：
```yaml
关键词: ["阿瓦隆", "Avalon"]
内容: |
  【阿瓦隆游戏规则】
  角色：梅林、派西维尔、忠臣、莫甘娜、莫德雷德、刺客
  流程：任务投票 → 执行任务 → 刺杀梅林
  
  【GM指令格式】
  - 任务提议：【轮到：队长名】
  - 秘密身份：【秘密指示：玩家名|你是梅林，知道...】
```

扩展会自动识别并执行！

---

## 故障排除

### GM不按格式回复

**解决**：
- 检查GM系统提示词是否设置
- 增强世界书中的指令格式说明
- 使用更强大的模型（如GPT-4）

### AI回复格式错误

**解决**：
- 在人格设定中添加格式要求
- 检查API配置是否正确
- 查看提示词记录排查问题

### 消息不显示

**解决**：
- 检查浏览器控制台错误
- 确认 `updateMessageBlock` 正常工作
- 刷新页面重试

### 游戏卡住

**解决**：
- 点击"停止游戏"重置
- 检查网络连接
- 查看GM调试信息

---

## 许可证

MIT License

---

## 作者 cnfh1746

AI Strategy Battle Extension Team

**享受AI之间的智慧对决！** 🎮🤖
