<link rel="stylesheet" href="style-final.css">

<div class="battle-settings-container">
    <div class="settings-header">
        <h2 class="main-title">🎮 AI策略对战配置</h2>
        <p class="subtitle">配置您的AI对战环境</p>
    </div>

    <!-- 游戏模式选择 -->
    <div class="settings-section mode-section">
        <h3 class="section-title">
            <span class="title-icon">🎯</span>
            <span>游戏模式</span>
        </h3>
        <select id="game_mode" class="input-field">
            <option value="universal">通用模式（依赖世界书/酒馆AI）</option>
            <option value="werewolf">狼人杀模式（内置规则，无需世界书）</option>
        </select>
        <div class="info-box">
            <div class="info-item">
                <span class="info-icon">💡</span>
                <div>
                    <strong>通用模式</strong>
                    <p>由酒馆AI（世界书）定义规则，GM根据规则主持</p>
                </div>
            </div>
            <div class="info-item">
                <span class="info-icon">🐺</span>
                <div>
                    <strong>狼人杀模式</strong>
                    <p>扩展内置完整狼人杀规则，自动管理游戏流程</p>
                </div>
            </div>
        </div>
    </div>

    <!-- GM 设置 -->
    <div id="gm_settings_container">
        <div class="settings-section" id="gm_system_prompt_section">
            <h3 class="section-title">
                <span class="title-icon">🎭</span>
                <span>GM 系统提示词</span>
            </h3>
            <p class="section-description">
                这段提示词会在每次调用 GM 时自动附加，用于明确 GM 的身份和任务。
            </p>
            <textarea id="gm_system_prompt" class="input-field textarea-field" rows="6">你是一个游戏主持人（GM），负责协调多个AI玩家进行游戏。

你的职责：
1. 严格根据聊天记录中的游戏规则主持游戏
2. 使用【轮到：玩家名】来指定某个玩家公开行动
3. 使用【秘密指示：玩家名|内容】来给某个玩家发送秘密信息
4. 绝对不要偏离当前游戏主题，不要回答无关问题</textarea>
        </div>

        <div class="settings-section">
            <h3 class="section-title">
                <span class="title-icon">🤖</span>
                <span>GM & 解说员 API 配置</span>
            </h3>
            
            <div id="commentator_section" class="commentator-toggle">
                <label class="toggle-label">
                    <input type="checkbox" id="commentatorEnabled" class="toggle-checkbox" />
                    <span class="toggle-switch"></span>
                    <span class="toggle-text">启用AI解说员（仅狼人杀模式）</span>
                </label>
                <p class="toggle-description">使用下方API配置生成游戏解说，增加观赏性</p>
            </div>

            <div class="commentator-style-box">
                <label class="field-label">解说风格（可选）</label>
                <textarea 
                    id="commentatorStyle" 
                    rows="3" 
                    class="input-field textarea-field"
                    placeholder="留空使用默认激情风格。或自定义：如'你是专业冷静的解说员...'"
                ></textarea>
            </div>
            
            <div class="api-config-grid">
                <div class="field-group">
                    <label class="field-label">API 地址</label>
                    <input id="gm_api_url" type="text" class="input-field" placeholder="https://api.openai.com/v1" />
                </div>
                <div class="field-group">
                    <label class="field-label">
                        模型
                        <button id="fetch_gm_models" class="icon-btn refresh-btn">
                            <span class="btn-icon">🔄</span>
                            <span class="btn-text">拉取</span>
                        </button>
                    </label>
                    <select id="gm_model" class="input-field"></select>
                </div>
            </div>
            
            <div class="field-group">
                <label class="field-label">API Key</label>
                <input id="gm_api_key" type="password" class="input-field" placeholder="sk-..." />
            </div>
        </div>
    </div>
    
    <!-- 6个AI配置 -->
    <div class="settings-section players-section">
        <h3 class="section-title">
            <span class="title-icon">👥</span>
            <span>玩家配置</span>
            <span class="player-count-badge">6位玩家</span>
        </h3>
        <div class="players-config" id="players_config_container">
            <!-- Player configs will be generated by JS -->
        </div>
    </div>
    
    <div class="save-section">
        <button id="save_battle_settings" class="save-btn">
            <span class="btn-icon">💾</span>
            <span class="btn-text">保存配置</span>
        </button>
    </div>
</div>

<!-- Player Template -->
<template id="player_config_template">
    <div class="player-card">
        <div class="player-card-header">
            <div class="player-avatar">
                <span class="avatar-text">{PLAYER_NUM}</span>
            </div>
            <div class="player-title">
                <h4>玩家 {PLAYER_NUM}</h4>
                <span class="player-status">未配置</span>
            </div>
            <button class="collapse-btn" onclick="this.closest('.player-card').classList.toggle('collapsed')">
                <span class="collapse-icon">▼</span>
            </button>
        </div>
        
        <div class="player-card-body">
            <div class="field-group">
                <label class="field-label">游戏中的名称（GM会用这个名字称呼）</label>
                <input type="text" id="player{PLAYER_NUM}_name" class="input-field" placeholder="例如：AI-Alpha">
            </div>
            <div class="field-group">
                <label class="field-label">API URL</label>
                <input type="text" id="player{PLAYER_NUM}_api_url" class="input-field" placeholder="https://api.openai.com/v1">
            </div>
            <div class="field-group">
                <label class="field-label">API Key</label>
                <input type="password" id="player{PLAYER_NUM}_api_key" class="input-field" placeholder="sk-...">
            </div>
            <div class="field-group">
                <label class="field-label">模型</label>
                <div class="model-input-group">
                    <select id="player{PLAYER_NUM}_model" class="input-field"></select>
                    <button id="fetch_player{PLAYER_NUM}_models" class="icon-btn" title="拉取模型列表">
                        <span>🔄</span>
                    </button>
                    <button id="test_player{PLAYER_NUM}_api" class="icon-btn test-btn" title="测试API连接">
                        <span>✓</span>
                    </button>
                </div>
            </div>
            <details class="advanced-section">
                <summary class="advanced-summary">
                    <span class="summary-icon">⚙️</span>
                    <span>高级：自定义人格提示词（可选）</span>
                </summary>
                <div class="advanced-content">
                    <textarea id="player{PLAYER_NUM}_custom_prompt" class="input-field textarea-field" placeholder="例如：你性格谨慎，不轻易相信他人..." rows="4"></textarea>
                </div>
            </details>
        </div>
    </div>
</template>
