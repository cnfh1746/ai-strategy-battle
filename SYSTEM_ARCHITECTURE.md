# AI策略对战系统架构 - 最终版

## 🎯 核心原则：世界书驱动

这个系统的核心设计思想是 **“世界书驱动”**。这意味着：

- **游戏规则在世界书中定义**：扩展代码本身是通用的，不包含任何特定游戏的逻辑（如狼人杀、阿瓦隆等）。
- **扩展只是协调者**：它的唯一工作是解析GM的指令，并协调外部AI轮流发言。
- **GM（酒馆AI）是主持人**：GM读取世界书中的规则，并根据这些规则来主持游戏。

---

## 🔄 完整流程（以狼人杀为例）

这是一个高度详细的流程，分清了每个环节的主体和职责。

### 阶段 0: 准备阶段 (用户操作)
**目标**: 让GM知道要玩什么游戏，并加载规则。

1.  **用户输入关键词**:
    - 用户在酒馆聊天框中输入一个与世界书条目匹配的关键词，例如: `"我们来玩狼人杀"`。

2.  **世界书激活**:
    - 酒馆检测到关键词 `"狼人杀"`。
    - 对应的世界书条目被激活，其内容被**注入到GM的下一个回复的上下文**中。

3.  **GM加载规则并开场**:
    - GM的上下文现在包含了完整的狼人杀规则、身份配置、流程和指令格式。
    - GM根据这些新信息，生成开场白，例如：
      > "好的，各位智慧体！欢迎来到《狼人杀》的逻辑战场。今晚的参与者有：AI-Alpha, AI-Beta... 规则如下：... 现在，天黑请闭眼..."

**到此为止，所有操作都和本扩展无关，完全是酒馆和世界书的机制。**

---

### 阶段 1: 启动扩展 (用户操作)
**目标**: 让扩展接管协调工作。

1.  **用户点击"开始游戏"**:
    - 用户在扩展的浮动面板上点击 **"▶️ 开始游戏"** 按钮。

2.  **扩展发送触发消息**:
    - 扩展被激活，它向酒馆聊天中插入一条系统消息，以触发GM继续游戏。这条消息很重要，它告诉GM扩展已经准备就绪。
    - 消息内容:
      > "🎮 扩展已启动。当前参与的AI: [玩家列表]。请根据你刚才说明的游戏规则继续主持。记得使用【轮到：玩家名】和【秘密指示：玩家名|内容】来协调游戏。"

3.  **GM分配身份**:
    - GM收到扩展的触发消息，并结合它已经记住的狼人杀规则，开始执行游戏的第一步：分配身份。
    - GM回复:
      > "好的，现在我将秘密分配身份...
      > 【秘密指示：AI-Alpha|你的身份是狼人，队友是AI-Beta】
      > 【秘密指示：AI-Beta|你的身份是狼人，队友是AI-Alpha】
      > 【秘密指示：AI-Gamma|你的身份是预言家】
      > ...
      > 身份分配完毕。狼人请睁眼，商讨目标。
      > 【轮到：AI-Alpha】"
      > *(注意: GM可能会一次性分配多个身份，也可能指定某个阵营，如【轮到：狼人阵营】。代码已支持模糊匹配。)*

---

### 阶段 2: 游戏循环 (扩展核心工作)
**目标**: 协调GM和玩家AI，推动游戏进行。

1.  **扩展解析GM指令**:
    - 扩展捕获到GM的回复。
    - **处理秘密指示**:
        - 使用正则表达式 `matchAll` 查找所有 `【秘密指示：...】`。
        - 对每一个匹配项：
            - 提取 `玩家名` 和 `秘密内容`。
            - 将 `秘密内容` 存入对应玩家的秘密信息队列 `playerSecrets` 中。
            - **重要**: 不在酒馆显示秘密原文，而是插入一条系统消息: `"🔒 系统: 已向 AI-Alpha 发送秘密信息"`，以防信息泄露。
    - **处理公开行动**:
        - 查找 `【轮到：...】` 指令。
        - 提取 `玩家名`。

2.  **扩展调用玩家AI**:
    - 假设GM指定 `【轮到：AI-Alpha】`。
    - 扩展通过API调用 `AI-Alpha`。
    - **构建提示词**: 这是玩家AI决策的依据，包含三部分：
        1.  `[人格设定]`: 在扩展设置中为该AI配置的自定义Prompt。
        2.  `[公开信息]`: 调用 `getChatContext()` 获取的酒馆最近50条聊天记录（已自动过滤掉秘密指示的原文）。
        3.  `[秘密信息]`: 从 `playerSecrets` 中取出的，只属于 `AI-Alpha` 的秘密信息（例如："你的身份是狼人，队友是AI-Beta"）。

3.  **玩家AI回复**:
    - `AI-Alpha` 根据收到的完整提示词，生成它的发言或行动。
    - 例如，回复: `"作为狼人，我建议第一晚刀掉预言家。我先跳个村民，看看情况。"`

4.  **扩展插入回复**:
    - 扩展收到 `AI-Alpha` 的回复。
    - 将其格式化后插入酒馆聊天: `"🎮 AI-Alpha: 作为狼人，我建议..."`。
    - 现在，这个发言成为了新的公开信息，所有人和AI都能看到。

5.  **暂停并等待用户继续**:
    - 为避免AI刷屏太快，扩展在每个AI行动后会自动暂停。
    - 它会插入一条系统消息: `"⏸️ 点击"继续游戏"进入下一步"`。
    - "继续游戏"按钮变为可用。

6.  **用户点击"继续游戏"**:
    - 扩展被唤醒，重新进入循环。
    - 它会再次向GM发送触发消息: `"请继续主持游戏，判断下一步行动"`。
    - GM看到 `AI-Alpha` 的发言后，继续主持，可能会说: `"好的，AI-Alpha发言完毕。现在【轮到：AI-Beta】"`。
    - 扩展解析新指令，调用 `AI-Beta`，循环继续。

---

### 阶段 3: 游戏结束
**目标**: 优雅地终止游戏。

1.  **GM宣布结束**:
    - 在某个时刻，GM判断游戏满足胜利或失败条件。
    - GM的回复中包含关键词 `"游戏结束"`。
    - 例如: `"狼人全部出局，好人阵营胜利！游戏结束。"`

2.  **扩展停止循环**:
    - 扩展在每次解析GM指令时，都会检查是否包含 `"游戏结束"`。
    - 检测到关键词后，扩展立即停止 `while` 循环。
    - 调用 `stopGame()` 函数，重置所有状态和UI。

---

## 🔌 关于其他游戏的适配

这个架构的美妙之处在于它的**通用性**。如果你想玩一个新游戏，比如 **"阿瓦隆"**：

1.  **创建新的世界书**:
    - 创建一个 `阿瓦隆.json` 世界书文件。
    - **关键词**: `"阿瓦隆"`
    - **内容**: 包含阿瓦隆的规则、角色配置（梅林、刺客等）、游戏流程、以及GM需要使用的指令格式（可能和狼人杀一样，也可能有新的）。

2.  **开始游戏**:
    - 用户在酒馆输入 `"玩阿瓦隆"`。
    - GM加载新规则并开场。
    - 用户点击扩展的"开始游戏"。

3.  **扩展无缝工作**:
    - 扩展代码**一行都不用改**。
    - 它仍然是那个忠实的协调者，负责解析GM的 `【轮到】` 和 `【秘密指示】`，并协调AI发言。
    - 游戏的所有逻辑和流程完全由GM（和它的世界书）决定。
