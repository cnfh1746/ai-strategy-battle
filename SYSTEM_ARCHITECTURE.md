# AI策略对战系统架构 - 完整流程说明

## 🎯 核心理念

**扩展只是协调者，不决定游戏规则！**
- ❌ 扩展不知道要玩什么游戏
- ✅ 游戏规则完全由GM角色卡和世界书定义
- ✅ 扩展只负责协调AI之间的通信

---

## 🎭 三个主体及职责

### 1. 酒馆主AI（GM）
**身份**: 游戏主持人（就是酒馆当前对话的AI角色）
**职责**:
- 📖 读取世界书中的游戏规则
- 🎲 根据规则分配角色身份
- ⚖️ 判断游戏进程（谁该发言、游戏是否结束）
- 📢 主持游戏流程（宣布夜晚/白天、公布结果）
- 🎯 做最终裁决

**知识来源**:
- 角色卡人设
- 世界书条目（游戏规则）
- 酒馆聊天历史

**输出格式**:
```
正常主持词...

【轮到：AI-Alpha】  // 让某个AI公开发言
【秘密指示：AI-Beta|你的身份是狼人】  // 给某个AI秘密信息
说"游戏结束"  // 宣布游戏结束
```

---

### 2. 6个玩家AI
**身份**: 游戏参与者，通过外部API调用
**职责**:
- 🎮 根据自己的角色行动
- 💬 在轮到自己时发言
- 🤔 根据公开信息+秘密信息做决策
- 🎯 完成自己阵营的胜利目标

**输入来源**:
- 人格设定（在扩展设置中配置）
- 公开信息（酒馆聊天历史，所有玩家都能看到）
- 秘密信息（只有自己知道，如身份、夜晚行动结果）

**输出**:
- 自由文本（发言、投票、行动声明）

---

### 3. 扩展系统
**身份**: 协调者、信使、秘书
**职责**:
- 🔄 **协调流程**: 监听GM指令，触发对应AI行动
- 📬 **传递消息**: 把玩家AI回复插入酒馆聊天
- 🔒 **管理秘密**: 维护每个AI的秘密信息队列
- 📊 **UI展示**: 显示游戏状态、玩家列表、提示词记录
- ⏯️ **流程控制**: 暂停/继续游戏

**严格禁止**:
- ❌ 不制定游戏规则（由GM角色卡/世界书定义）
- ❌ 不判断游戏逻辑（由GM决定）
- ❌ 不生成游戏内容（由GM和玩家AI生成）
- ❌ 不插入游戏规则说明（GM自己会说）

---

## 🔄 完整流程（以狼人杀为例）

### 准备阶段：配置世界书

```yaml
# 世界书条目示例：狼人杀
keys: ["狼人杀", "开始游戏"]
content: |
  # 狼人杀游戏规则
  
  ## 角色配置（6人局）
  - 2名狼人：夜晚可以杀人
  - 1名预言家：夜晚可以查验一人身份
  - 1名女巫：有一瓶解药和一瓶毒药
  - 2名村民：无特殊能力
  
  ## 游戏流程
  1. 天黑请闭眼（分配身份）
  2. 狼人睁眼（商讨杀人目标）
  3. 预言家睁眼（查验身份）
  4. 女巫睁眼（使用药剂）
  5. 天亮了（宣布死亡信息）
  6. 玩家依次发言
  7. 投票放逐
  8. 判断胜负
  
  ## 胜利条件
  - 狼人胜利：所有好人出局
  - 好人胜利：所有狼人出局
  
  ## GM指令格式
  使用【轮到：玩家名】让某个AI发言
  使用【秘密指示：玩家名|信息】发送秘密信息
```

---

### 阶段1: 触发游戏

```
[用户] 在酒馆输入框输入: "狼人杀"
  ↓
[酒馆系统] 世界书条目被激活（关键词匹配）
  ↓
[用户] 点击发送
  ↓
[酒馆GM] 读取世界书+聊天历史，生成回复：
  "欢迎来到狼人杀游戏！
   参与玩家有：AI-Alpha、AI-Beta、AI-Gamma、AI-Delta、AI-Echo、AI-Foxtrot
   
   现在开始分配身份...
   【秘密指示：AI-Alpha|你的身份是狼人，队友是AI-Beta】
   【秘密指示：AI-Beta|你的身份是狼人，队友是AI-Alpha】
   【秘密指示：AI-Gamma|你的身份是预言家】
   ..."
  ↓
[酒馆] GM的回复出现在聊天记录中
```

**❗ 注意**：此时扩展还没启动，这只是正常的酒馆对话！

---

### 阶段2: 启动扩展协调

```
[用户] 看到GM已经开始游戏，点击扩展的"开始游戏"按钮
  ↓
[扩展] 开始监听和协调流程
  ↓
[扩展] 读取当前酒馆聊天历史（包含GM刚才的身份分配）
  ↓
[扩展] 解析GM的历史消息，提取秘密指示：
  - 找到【秘密指示：AI-Alpha|...】
  - 存储到 playerSecrets['p1']
  - 在酒馆插入系统消息: "🔒 已向 AI-Alpha 发送秘密信息"
  （重复处理所有秘密指示）
  ↓
[扩展] 向酒馆发送触发消息: 
  "🎮 系统: 扩展已启动，请GM继续主持游戏"
  ↓
[扩展] 触发GM生成回复（generateRaw）
  ↓
[酒馆GM] 基于完整聊天历史（包含自己刚才的身份分配）回复：
  "好的，身份分配完毕。现在天黑请闭眼...
   【轮到：狼人阵营】"
```

---

### 阶段3: 游戏主循环

```
═══════════════════════════════════════
循环开始（每一轮）
═══════════════════════════════════════

[扩展] 解析GM最新回复
  ↓
  ┌─ 如果包含【秘密指示：AI名|内容】
  │   ↓
  │   [扩展] 存储秘密信息到对应AI的队列
  │   [扩展] 在酒馆插入: "🔒 已向 AI名 发送秘密信息"
  │   [扩展] 继续等待GM下一步指令
  │
  ├─ 如果包含【轮到：AI名】
  │   ↓
  │   [扩展] 调用对应玩家AI的API
  │   [扩展] 构建提示词:
  │       ┌─────────────────────────┐
  │       │ [人格设定]              │
  │       │ 你的自定义人格...       │
  │       │                         │
  │       │ [公开信息]              │
  │       │ 酒馆聊天历史（所有AI可见）│
  │       │                         │
  │       │ [秘密信息 - 只有你知道] │
  │       │ 你的身份是狼人          │
  │       │ 昨晚你杀了XX            │
  │       └─────────────────────────┘
  │   ↓
  │   [玩家AI] 思考并生成回复
  │   ↓
  │   [扩展] 把AI回复插入酒馆聊天:
  │       "🎮 AI-Alpha: 我觉得AI-Gamma很可疑..."
  │   ↓
  │   [扩展] 插入暂停消息: "⏸️ 点击'继续游戏'进入下一步"
  │   ↓
  │   [用户] 点击"继续游戏"按钮
  │   ↓
  │   [扩展] 向酒馆发送触发消息: "请GM继续"
  │   ↓
  │   [扩展] 触发GM生成回复
  │   ↓
  │   [酒馆GM] 基于完整聊天历史（包含刚才AI的发言）回复：
  │       "好的，AI-Alpha发言完毕。
  │        现在轮到下一位...
  │        【轮到：AI-Beta】"
  │
  └─ 如果包含"游戏结束"
      ↓
      [扩展] 停止游戏循环
      [扩展] 显示游戏结束

═══════════════════════════════════════
回到循环开始
═══════════════════════════════════════
```

---

## 📊 信息流转图

```
┌──────────────┐
│   世界书     │ ← 游戏规则存储在这里
│  (狼人杀规则) │
└──────┬───────┘
       │ 触发（关键词匹配）
       ↓
┌──────────────┐
│   酒馆GM     │ ← 唯一的决策者
│ (读取世界书)  │
└──────┬───────┘
       │ 生成指令【轮到：XX】
       ↓
┌──────────────┐
│   扩展系统   │ ← 协调者（解析指令，调度AI）
└──────┬───────┘
       │ 调用API
       ↓
┌──────────────┐
│   玩家AI    │ ← 执行者（接收指令，生成回复）
│  (外部API)  │
└──────┬───────┘
       │ 回复插入
       ↓
┌──────────────┐
│  酒馆聊天记录 │ ← 所有信息汇总
│ (共享上下文)  │
└──────┬───────┘
       │ GM读取历史
