# AI策略对战系统架构 - 职责分配

## 🎭 主体划分

### 1. 酒馆主AI（GM）
**身份**: 游戏主持人，在酒馆角色卡中设定
**职责**:
- 📋 制定游戏规则（通过角色卡/预设配置）
- 🎲 分配角色身份（发送秘密指示）
- ⚖️ 判断游戏进程（谁该发言、游戏是否结束）
- 📢 主持游戏流程（宣布夜晚/白天、公布结果）
- 🎯 做最终裁决

**输入来源**:
- 酒馆聊天历史（包含所有玩家发言）
- 扩展发送的系统指令（触发GM思考）

**输出格式**:
```
正常主持词...

【轮到：AI-Alpha】  // 让某个AI公开发言
【秘密指示：AI-Beta|你的身份是狼人】  // 给某个AI秘密信息
说"游戏结束"  // 宣布游戏结束
```

---

### 2. 6个玩家AI
**身份**: 游戏参与者，通过外部API调用
**职责**:
- 🎮 根据自己的角色行动
- 💬 在轮到自己时发言
- 🤔 根据公开信息+秘密信息做决策
- 🎯 完成自己阵营的胜利目标

**输入来源**:
- 人格设定（在扩展设置中配置）
- 公开信息（酒馆聊天历史，所有玩家都能看到）
- 秘密信息（只有自己知道，如身份、夜晚行动结果）

**输出**:
- 自由文本（发言、投票、行动声明）

---

### 3. 扩展系统
**身份**: 协调者、信使、秘书
**职责**:
- 🔄 **协调流程**: 监听GM指令，触发对应AI行动
- 📬 **传递消息**: 把玩家AI回复插入酒馆聊天
- 🔒 **管理秘密**: 维护每个AI的秘密信息队列
- 📊 **UI展示**: 显示游戏状态、玩家列表、提示词记录
- ⏯️ **流程控制**: 暂停/继续游戏

**不负责**:
- ❌ 不制定游戏规则（由GM角色卡定义）
- ❌ 不判断游戏逻辑（由GM决定）
- ❌ 不生成游戏内容（由GM和玩家AI生成）

---

## 🔄 完整流程（修正版）

### 阶段1: 初始化
```
[扩展] 点击"开始游戏"
  ↓
[扩展] 在酒馆插入游戏开始提示
  ↓
[扩展] 向酒馆发送触发消息: "请开始游戏并分配身份"
  ↓
[酒馆GM] 基于角色卡设定，生成开场白并分配身份
  输出: "游戏开始！【秘密指示：AI-Alpha|狼人】..."
  ↓
[扩展] 解析GM回复，提取秘密指示，存储到对应AI的秘密队列
```

### 阶段2: 游戏循环
```
循环开始
  ↓
[扩展] 向酒馆发送触发消息: "请判断下一步行动"
  ↓
[酒馆GM] 基于完整聊天历史，判断游戏状态
  - 阅读所有历史发言
  - 判断是否有人出局、游戏是否结束
  - 决定下一个行动者
  输出: "【轮到：AI-Alpha】" 或 "【秘密指示：...】" 或 "游戏结束"
  ↓
[扩展] 解析GM指令
  ↓
  如果是【秘密指示】→ 存储到对应AI秘密队列，继续循环
  ↓
  如果是【轮到：XX】→ 调用对应玩家AI
    ↓
    [玩家AI] 接收输入:
      - 人格设定
      - 公开信息（酒馆聊天历史）
      - 秘密信息（自己的秘密队列）
    ↓
    [玩家AI] 生成回复（发言/投票/行动）
    ↓
    [扩展] 把玩家回复插入酒馆聊天
      格式: "🎮 AI-Alpha: 我认为..."
  ↓
  如果是"游戏结束"→ 停止循环
  ↓
[扩展] 暂停，等待用户点击"继续"
  ↓
回到循环开始
```

---

## 🎯 关键点

### 1. GM是唯一的决策者
- ✅ GM决定谁该发言
- ✅ GM决定游戏何时结束
- ✅ GM判断游戏状态（谁出局、哪方获胜）
- ❌ 扩展只是执行GM的指令

### 2. 聊天历史是共享的真相
- 所有玩家AI看到相同的公开信息（酒馆聊天记录）
- 秘密信息存储在扩展中，只在调用对应AI时附加
- GM也能看到完整的聊天历史（通过酒馆上下文）

### 3. 扩展是透明的协调者
```
用户 → [扩展: 触发] → 酒馆GM → [扩展: 解析] → 玩家AI → [扩展: 插入] → 酒馆聊天
                          ↑                                               ↓
                          └───────────────── 读取历史 ────────────────────┘
```

---

## 🔧 当前实现的问题

### 问题1: GM调用方式
**当前代码**:
```javascript
async callGM(userMessage) {
    this.appendToChat('🎮 系统', userMessage);  // ✅ 插入系统消息
    await new Promise(resolve => setTimeout(resolve, 100));
    const response = await generateRaw('', '', false, false);  // ✅ 触发GM回复
    return response;
}
```

**潜在问题**:
- `generateRaw('', '', ...)` 第一个参数是空字符串
- 这会触发GM基于**完整聊天历史**生成回复
- ✅ 这是对的！GM应该基于完整历史判断

### 问题2: 玩家AI的提示词构建
**当前代码**:
```javascript
prompt += `[公开信息 - 所有玩家都能看到]\n`;
prompt += this.getChatContext();  // 获取酒馆聊天历史

if (includeSecret && this.playerSecrets[playerId].length > 0) {
    prompt += `\n\n[秘密信息 - 只有你知道]\n`;
    prompt += this.playerSecrets[playerId].join('\n');
}
```

**潜在问题**:
- getChatContext() 会移除秘密指示标记
- ✅ 这是对的！其他玩家不应该看到秘密指示

### 问题3: 秘密信息的传递
**当前流程**:
1. GM说: `【秘密指示：AI-Alpha|你是狼人】`
2. 扩展解析并存储到 `playerSecrets['p1']`
3. 调用AI-Alpha时，附加秘密信息到提示词

**潜在问题**:
- ❌ 秘密指示出现在酒馆聊天中，其他AI可能看到！

**解决方案**:
- getChatContext() 已经移除了秘密指示标记
- 但显示上可以优化：让秘密指示不显示原文，只显示"[已发送秘密指示给XX]"

---

## 📝 建议优化

1. **秘密指示的显示**
   - GM输出秘密指示后，在酒馆中只显示: `[系统已向AI-Alpha发送秘密信息]`
   - 原始内容不出现在聊天记录中

2. **GM的触发方式**
   - 确保GM每次都能看到完整的游戏历史
   - 系统消息应该清晰明确，但不要过于冗长

3. **玩家AI的回复格式**
   - 统一前缀: `🎮 AI名字:`
   - 让GM和其他AI容易识别

4. **错误处理**
   - 如果GM格式错误，给出明确提示
   - 如果玩家API失败，插入"(沉默)"占位符
